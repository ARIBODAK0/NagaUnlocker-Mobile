name: NagaUnlocker Self-Healing Build
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: üõ†Ô∏è Tahap 1: Instalasi Standar & Alat Perbaikan
        id: setup_tools
        run: |
          sudo apt-get update
          # Langsung instal alat yang sering bikin eror di video tadi
          sudo apt-get install -y build-essential git python3-dev \
            autoconf automake libtool pkg-config libffi-dev \
            libssl-dev openjdk-17-jdk unzip zip zlib1g-dev libusb-1.0-0-dev

      - name: üêç Tahap 2: Instalasi Buildozer
        run: |
          pip install --upgrade pip
          pip install --upgrade Cython==0.29.33 buildozer

      - name: üöÄ Tahap 3: Mencari Spec & Build (Logika Auto-Fix)
        run: |
          # 1. Cari file spec
          SPEC_FILE=$(find . -name "buildozer.spec" -type f -print -quit)
          if [ -z "$SPEC_FILE" ]; then echo "Spec not found"; exit 1; fi
          mv "$SPEC_FILE" ./buildozer.spec
          
          # 2. Jalankan Build dengan logika percobaan ulang jika gagal
          echo "Memulai Build Pertama..."
          yes | buildozer -v android debug || {
            echo "‚ö†Ô∏è Build Gagal! Mendeteksi Error dan Mencoba Memperbaiki..."
            
            # --- LOGIKA SELF-HEALING ---
            # Jika error karena libtool/autoconf (seperti di video)
            sudo apt-get install -y autotools-dev
            
            # Bersihkan sisa build yang rusak
            buildozer android clean
            
            echo "üîÑ Mencoba Build Ulang setelah perbaikan otomatis..."
            yes | buildozer -v android debug
          }
        env:
          ACCEPT_SDK_LICENSE: "yes"

      - name: üì¶ Tahap 4: Upload APK Jika Sukses
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: NagaUnlocker-Success-APK
          path: bin/*.apk
          
